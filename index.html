<!doctype html>
<html lang="en">
    <head>
        <title>BLF Dashboard</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <!-- Latest compiled and minified CSS -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

        <!-- Optional theme -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
        
        <style>
            .shaded {
                background: #eeeeee;
                padding: 20px;
                margin-bottom: 20px;
                border-top: 10px solid #cccccc;
            }
        </style>

    </head>
    <body>
        <div class="container">
            <div class="page-header">
                <h1>Big Lottery Fund <small>Alpha website dashboard</small></h1>
            </div>

            <!-- server statuses -->
            <h2>Server statuses</h2>
            <div class="row">
                <div class="col-sm-6"><div id="js-server-status-test"></div></div>
                <div class="col-sm-6"><div id="js-server-status-live"></div></div>
            </div>

            <!-- github stats -->
            <h2>Github status</h2>
            <div class="row">
                <div class="col-sm-4 text-center"><div id="js-gh-issues"></div></div>
                <div class="col-sm-4 text-center"><div id="js-gh-prs"></div></div>
                <div class="col-sm-4 text-center"><div id="js-gh-branches"></div></div>
            </div>

            <!-- perf stats -->
            <h2>Performance</h2>
            <div class="row">
                <div class="col-sm-6 text-center"><div class="shaded" id="js-perf-legacy">Loading...</div></div>
                <div class="col-sm-6 text-center"><div class="shaded" id="js-perf-new">Loading...</div></div>
            </div>
        </div>

        <!-- load app config data (not in git!) -->
        <script src="config.js"></script>

        <script>

            // fetch server statuses
            const servers = [
                {
                    name: "Test",
                    url: BLF_CONF.servers.test.url,
                    elm: document.getElementById('js-server-status-test')
                },
                {
                    name: "Production",
                    url: BLF_CONF.servers.prod.url,
                    elm: document.getElementById('js-server-status-live')
                }
            ];

            servers.forEach(s => {
                fetch(s.url + '/status').then(r => r.json()).then(j => {
                    s.elm.innerHTML = `<h3>${s.name}
                        <small><a href="${s.url}/status">status</a> | <a href="${s.url}/status/pages">pagelist</a></small></h3>
                        <pre>${JSON.stringify(j, null, 4)}</pre>`;
                });
            });

            // get github data
            const GH_ACCOUNT = 'biglotteryfund';
            const GH_REPO = 'blf-alpha';
            const GH_ISSUES = `https://api.github.com/repos/${GH_ACCOUNT}/${GH_REPO}/issues?per_page=100`;
            const GH_BRANCHES = `https://api.github.com/repos/${GH_ACCOUNT}/${GH_REPO}/branches`;

            fetch(GH_ISSUES).then(r => r.json()).then(j => {
                let issues = j.filter(i => typeof i.pull_request === 'undefined');
                let pull_requests = j.filter(i => typeof i.pull_request !== 'undefined');
                document.getElementById('js-gh-issues').innerHTML =
                    `<h2>${issues.length || 0}</h2> <h5 class="text-uppercase">open issues</h5>`;
                document.getElementById('js-gh-prs').innerHTML =
                    `<h2>${pull_requests.length || 0}</h2> <h5 class="text-uppercase">pull requests</h5>`;
            });

            fetch(GH_BRANCHES).then(r => r.json()).then(branches => {
                document.getElementById('js-gh-branches').innerHTML =
                    `<h2>${branches.length || 0}</h2> <h5 class="text-uppercase">branches</h5>`;
            });

            const pagespeedKey = BLF_CONF.pagespeed.key;
            const pagespeedApiUrl = 'https://www.googleapis.com/pagespeedonline/v2/runPagespeed?';


            let pagespeedTests = [
                {
                    url: 'https://biglotteryfund.org.uk',
                    title: 'Legacy site',
                    elm: document.getElementById('js-perf-legacy')
                },
                {
                    url:  'https://www.biglotteryfund.org.uk/funding/funding-guidance/managing-your-funding',
                    title: 'New site',
                    elm: document.getElementById('js-perf-new')
                }
            ];

            function formatBytes(a,b){
                if (0 == a) { return "0 Bytes" };
                let c = 1e3, d = b || 2, e = ["Bytes", "KB", "MB", "GB", "TB", "PB", "EB", "ZB", "YB"],
                    f = Math.floor(Math.log(a) / Math.log(c));
                return parseFloat((a / Math.pow(c, f)).toFixed(d)) + " " + e[f]
            }


            // via https://stackoverflow.com/a/17268489
            function getColor (value) {
                //value from 0 to 1
                let hue=((1-value)*120).toString(10);
                return ["hsl(",hue,",100%,50%)"].join("");
            }

            let makePerfStats = (test, data) => {
                let s = data.pageStats;
                let bytes = [
                    s.htmlResponseBytes,
                    s.textResponseBytes,
                    s.cssResponseBytes,
                    s.imageResponseBytes,
                    s.javascriptResponseBytes,
                    s.flashResponseBytes,
                    s.otherResponseBytes
                ];
                bytes = bytes.map(b => parseInt(b) || 0);
                let totalBytes = bytes.reduce((a, b) => a + b, 0);

                let hex = getColor(parseInt(data.ruleGroups.SPEED.score) / 100);
                test.elm.style.borderTopColor = hex;

                let str = '';
                str += `<h4>${test.title}</h4>`;
                str += '<div class="row"><div class="col-sm-4 text-center">';
                str += `<h3>${data.ruleGroups.SPEED.score} / 100</h3> <h5 class="text-uppercase">pagespeed score</h5>`;
                str += '</div><div class="col-sm-4 text-center">';
                str += `<h3>${data.pageStats.numberResources}</h3> <h5 class="text-uppercase">Resources</h5>`;
                str += '</div><div class="col-sm-4 text-center">';
                str += `<h3>${formatBytes(totalBytes)}</h3> <h5 class="text-uppercase">Page weight</h5>`;
                str += '</div></div>';
                return str;
            };

            pagespeedTests.forEach(test => {
                // get pagespeed data
                let query = [
                    'url=' + test.url,
                    'key=' + pagespeedKey
                ].join('&');
                let url = pagespeedApiUrl + query;
                fetch(url).then(r => r.json()).then(j => {
                    console.log(j);
                    let html = makePerfStats(test, j);
                    test.elm.innerHTML = html;
                });
            });


        </script>

    </body>
</html>